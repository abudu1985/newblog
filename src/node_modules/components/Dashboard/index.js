import React, {useContext, useEffect, useState} from 'react'
import {CurrentUserContext} from "contexts/currentUser";
import './style.css'
import firebase from "../../../firebase";
import Spinner from '../Spinner';
import RoundButton from '../RoundButton';
import useToast from "components/Toaster/useToast";
import {ArticlesDataContext} from "contexts/articlesData";


const Dashboard = ({history}) => {
    const [currentUserState] = useContext(CurrentUserContext);
    const [tableData, setTableData] = useState([]);
    const toast = useToast();
    const [articlesData, dispatch] = useContext(ArticlesDataContext);

    useEffect(() => {
        if (!currentUserState.isLoggedIn) {
            history.replace('/')
        }
        setTableData(articlesData.articles);

    }, [currentUserState, history, articlesData]);

    function onEdit(data) {
        history.push({
            pathname: `/articles/${data.slug}/edit`,
            state: {data}
        })
    }

    function onDelete(id) {
        window.confirm("Are you sure you wish to delete this article?") &&
        firebase.deleteArticle(id).then(ref => {
            const withDeletedData = tableData.filter(t => t.id !== id);
            setTableData(withDeletedData);
            dispatch({type: 'DELETE_ARTICLE', payload: withDeletedData})
            toast.add('Article was deleted!', 'success');
        })
            .catch(error => {
                toast.add(`${error}`, 'danger');
            });
    }

    return <div>
        {tableData.length ?
            <table>
                <caption>A summary of articles</caption>
                <thead>
                <tr>
                    <th scope="col">Title</th>
                    <th scope="col">Tags</th>
                    <th scope="col">Published</th>
                    <th scope="col">Preview</th>
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody>
                {tableData.map(doc => (
                    <tr key={doc.title}>
                        <th scope="row">{doc.title}</th>
                        <td>{doc.tagList.map(tag => (<span key={tag}>{tag}&nbsp;</span>))}</td>

                        <th scope="row">
                            <span className={doc.isPublished ? "published-blue" : "published-red"}>
                                {doc.isPublished ? <span>&#10004;</span> : <span>&#x2716;</span>}
                            </span>
                        </th>
                        <th scope="row">
                            <img className="dashboardPreviewImage" src={doc.articlePreview} alt=""/>
                        </th>

                        <th scope="row">
                            <RoundButton innerHtml={'Edit'} onClick={() => onEdit(doc)}/>
                            <RoundButton innerHtml={'Delete'} onClick={() => onDelete(doc.id)} color={'red'}/>
                        </th>
                    </tr>
                ))}
                </tbody>
                <tfoot>
                <tr>
                    <th scope="row" colSpan="5">{`Total  ${tableData.length}`}</th>
                </tr>
                </tfoot>
            </table> : <Spinner/>
        }
    </div>
};

export default Dashboard;